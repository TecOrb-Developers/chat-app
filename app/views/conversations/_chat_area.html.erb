<%= turbo_stream_from [@conversation, "messages"] %>

<div class="flex flex-col h-screen bg-white dark:bg-gray-900"
     data-controller="conversation"
     data-conversation-conversation-id-value="<%= @conversation&.id %>"
     data-conversation-current-user-id-value="<%= current_user.id %>">
  
  <!-- Chat Header (Responsive) -->
  <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4 md:pt-4">
    <div class="flex items-center space-x-3">
      <!-- Back button (mobile only) -->
      <div class="md:hidden">
        <%= link_to conversations_path, class: "p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        <% end %>
      </div>

      <!-- Avatar -->
      <div class="relative flex-shrink-0">
        <% if @conversation.conversation_type == 'group_chat' %>
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center">
            <span class="text-white font-semibold"><%= @conversation.title[0..1].upcase %></span>
          </div>
        <% else %>
          <img src="<%= @conversation.other_user(current_user).avatar.attached? ? 
                      url_for(@conversation.other_user(current_user).avatar) : 
                      "https://ui-avatars.com/api/?name=#{@conversation.other_user(current_user).username}&background=random" %>" 
               class="w-10 h-10 rounded-full object-cover">
          <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white dark:border-gray-800"></span>
        <% end %>
      </div>

      <!-- User/Group Info -->
      <div class="flex-1 min-w-0">
        <h2 class="font-semibold text-gray-900 dark:text-white truncate">
          <%= @conversation.conversation_type == 'group_chat' ? @conversation.title : @conversation.other_user(current_user).username %>
        </h2>
        <p class="text-xs text-gray-500 dark:text-gray-400">
          <%= @conversation.conversation_type == 'group_chat' ? 
                pluralize(@conversation.users.count, 'member') : 
                'Online' 
          %>
        </p>
      </div>

      <!-- Menu Button -->
      <button class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Messages Container -->
  <div class="flex-1 overflow-y-auto p-4 space-y-2 md:space-y-4 pb-24 md:pb-4"
       id="messages"
       data-conversation-target="messagesContainer"
       style="-webkit-overflow-scrolling: touch;">
    <% if @messages.present? %>
      <%= render partial: "messages/message", 
                 collection: @messages, 
                 as: :message, 
                 locals: { current_user: current_user } %>
    <% else %>
      <div class="flex items-center justify-center h-full text-gray-400 dark:text-gray-500">
        <div class="text-center p-6">
          <div class="w-16 h-16 mx-auto mb-4 text-gray-200 dark:text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
          </div>
          <p class="text-gray-500 dark:text-gray-400">No messages yet. Say hello!</p>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Message Input (Fixed on mobile, normal flow on desktop) -->
  <div class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 fixed bottom-0 left-0 right-0 md:static">
    <%= render "conversations/message_form", conversation: @conversation %>
  </div>
</div>