<!-- app/views/messages/_form.html.erb -->
<%= turbo_frame_tag "new_message" do %>
<%= form_with(model: [conversation, message], 
    data: { 
      controller: "message-form",
      action: "turbo:submit-end->message-form#resetForm"
    }) do |f| %>
  <div class="input-group">
    <%= f.text_area :content,
                rows: 1,
                placeholder: "Type a message...",
                class: "w-full resize-none rounded-lg border border-gray-300 p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500",
                data: { 
                  controller: "typing-indicator autosize",
                  action: "input->typing-indicator#userTyping input->autosize#resize keydown.enter->message-form#handleSubmit",
                  typing_indicator_conversation_id_value: @conversation.id
                } %>
    
    <div class="input-group-append">
      <label class="btn btn-outline-secondary" style="cursor: pointer;">
        <i class="bi bi-paperclip"></i>
        <%= f.file_field :attachments, 
              multiple: true, 
              style: "display: none;",
              data: { action: "change->message-form#handleFiles" } %>
      </label>
      <%= f.button type: "submit", class: "btn btn-primary" do %>
        <i class="bi bi-send"></i>
      <% end %>
    </div>
  </div>
  
  <div id="file-preview" class="mt-2" data-message-form-target="filePreview"></div>
<% end %>
<% end %>

<%= javascript_tag nonce: true do %>
  document.addEventListener("DOMContentLoaded", function() {
    // Auto-resize textarea
    const textarea = document.querySelector("textarea[data-message-form-target='input']");
    if (textarea) {
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });
    }
    
    // Scroll to bottom of messages
    const messagesContainer = document.getElementById('messages');
    if (messagesContainer) {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  });
<% end %>